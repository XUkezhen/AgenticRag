<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 智能助手 Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --sidebar-width: 280px;
            --primary-color: #10a37f;
            --bg-color: #ffffff;
            --sidebar-bg: #f0f0f0; /* 更柔和的灰色 */
            --border-color: #e5e5e5;
        }

        body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* --- 侧边栏 --- */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .new-chat-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            transition: 0.2s;
        }
        .new-chat-btn:hover { opacity: 0.9; }

        .session-list {
            flex: 1;
            overflow-y: auto;
        }

        .session-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: white;
            border: 1px solid transparent;
            font-size: 14px;
            color: #333;
        }
        .session-item:hover { background: #e8e8e8; }
        .session-item.active {
            border-color: var(--primary-color);
            background: #e6f4f1;
            color: var(--primary-color);
            font-weight: 500;
        }

        .edit-icon {
            opacity: 0;
            color: #888;
            font-size: 12px;
            padding: 4px;
        }
        .session-item:hover .edit-icon { opacity: 1; }
        .edit-icon:hover { color: var(--primary-color); }

        /* --- 主区域 --- */
        .main { flex: 1; display: flex; flex-direction: column; background: var(--bg-color); }

        .header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }
        .session-title { font-size: 16px; font-weight: bold; }

        .chat-box {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        .message { margin-bottom: 25px; display: flex; gap: 15px; }
        .message.user { flex-direction: row-reverse; }

        .avatar {
            width: 36px; height: 36px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        .avatar.ai { background: #19c37d; color: white; }
        .avatar.user { background: #555; color: white; }

        .bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 8px;
            line-height: 1.6;
            font-size: 15px;
            position: relative;
        }
        .message.ai .bubble { background: #f7f7f8; color: #333; }
        .message.user .bubble { background: var(--primary-color); color: white; }

        .status-tag {
            font-size: 12px; color: #888; margin-bottom: 5px; font-style: italic;
        }

        /* --- 输入区 --- */
        .input-wrapper {
            padding: 20px;
            border-top: 1px solid var(--border-color);
        }
        .input-box {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }
        textarea {
            border: none; outline: none; resize: none;
            min-height: 50px; max-height: 150px;
            font-family: inherit; font-size: 15px;
        }
        .toolbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #f0f0f0;
        }
        .tools-left { display: flex; gap: 15px; align-items: center; }

        .icon-btn { cursor: pointer; color: #666; font-size: 18px; }
        .icon-btn:hover { color: var(--primary-color); }

        .send-btn {
            background: var(--primary-color); color: white;
            border: none; padding: 6px 15px; border-radius: 6px;
            cursor: pointer;
        }
        .send-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* 开关样式 */
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 20px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(16px); }
        .switch-label { font-size: 12px; color: #666; margin-left: 8px; }
        /* --- 新增：加载转圈动画 --- */
        .loading-spinner {
            border: 3px solid #f3f3f3; /* 浅灰底色 */
            border-top: 3px solid #10a37f; /* 主色调 */
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <button class="new-chat-btn" onclick="createNewSession()">
        <i class="fas fa-plus"></i> 新建对话
    </button>
    <div class="session-list" id="sessionList">
        </div>
</div>

<div class="main">
    <div class="header">
        <span class="session-title" id="headerTitle">请选择或新建会话</span>
        <div style="display: flex; align-items: center;">
            <label class="switch">
                <input type="checkbox" id="webToggle">
                <span class="slider"></span>
            </label>
            <span class="switch-label">联网模式</span>
        </div>
    </div>

    <div class="chat-box" id="chatBox">
        <div style="text-align: center; color: #999; margin-top: 50px;">
            <i class="fas fa-robot" style="font-size: 40px; margin-bottom: 10px;"></i>
            <p>基于 LangGraph 的增强型 AI 助手</p>
        </div>
    </div>

    <div class="input-wrapper">
        <div class="input-box">
            <textarea id="userInput" placeholder="输入问题... (Ctrl+Enter 换行，Enter 发送)"
                onkeydown="if(event.keyCode===13 && !event.ctrlKey){event.preventDefault();sendMsg()}"></textarea>

            <div class="toolbar">
                <div class="tools-left">
                    <label class="icon-btn" title="上传文件">
                        <i class="fas fa-paperclip"></i>
                        <input type="file" style="display: none" onchange="uploadFile(this.files)">
                    </label>
                </div>
                <button class="send-btn" id="sendBtn" onclick="sendMsg()">
                    <i class="fas fa-paper-plane"></i> 发送
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    const API = "http://127.0.0.1:8000";
    let currentSessionId = null;
    let isGenerating = false;

    // --- 初始化 ---
    window.onload = async () => {
        await loadSessionList();
    };

    // 1. 加载会话列表
    async function loadSessionList() {
        try {
            const res = await fetch(`${API}/sessions`);
            const data = await res.json();
            const listDiv = document.getElementById("sessionList");
            listDiv.innerHTML = "";

            data.sessions.forEach(s => {
                const div = document.createElement("div");
                div.className = `session-item ${s.id === currentSessionId ? 'active' : ''}`;
                div.innerHTML = `
                    <span onclick="switchSession('${s.id}', '${s.name}')" style="flex:1; overflow:hidden; text-overflow:ellipsis;">${s.name}</span>
                    <i class="fas fa-pen edit-icon" onclick="renameSession('${s.id}')" title="重命名"></i>
                `;
                listDiv.appendChild(div);
            });
        } catch (e) {
            console.error("加载列表失败", e);
        }
    }

    // 2. 新建会话
    async function createNewSession() {
        const res = await fetch(`${API}/session/new`, { method: "POST" });
        const data = await res.json();
        await loadSessionList();
        switchSession(data.session_id, data.name);
    }

    // 3. 切换会话 (核心逻辑：加载历史)
    async function switchSession(id, name) {
        currentSessionId = id;
        document.getElementById("headerTitle").textContent = name;

        // 更新左侧高亮
        document.querySelectorAll(".session-item").forEach(el => el.classList.remove("active"));
        // 重新渲染列表以更新 active 状态 (简单处理)
        await loadSessionList();

        const chatBox = document.getElementById("chatBox");
        chatBox.innerHTML = '<p style="text-align:center;color:#999">正在加载历史记录...</p>';

        try {
            // 获取历史消息
            const res = await fetch(`${API}/session/${id}/history`);
            const data = await res.json();

            chatBox.innerHTML = ""; // 清空 loading
            if (data.messages.length === 0) {
                 chatBox.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">这是一个新会话，开始提问吧！</p>';
            } else {
                data.messages.forEach(msg => appendBubble(msg.role, msg.content));
            }
        } catch (e) {
            chatBox.innerHTML = '<p style="text-align:center;color:red">加载历史失败</p>';
        }
    }

    // 4. 重命名
    async function renameSession(id) {
        const newName = prompt("请输入新的会话名称：");
        if (newName) {
            await fetch(`${API}/session/${id}/rename`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: newName })
            });
            loadSessionList();
            if (currentSessionId === id) document.getElementById("headerTitle").textContent = newName;
        }
    }

    // 5. 发送消息
    async function sendMsg() {
        if (!currentSessionId) { alert("请先新建会话"); return; }
        const input = document.getElementById("userInput");
        const txt = input.value.trim();
        if (!txt || isGenerating) return;

        isGenerating = true;
        document.getElementById("sendBtn").disabled = true;
        input.value = "";

        appendBubble("user", txt);
        const aiBubble = appendBubble("ai", "..."); // 占位符

        try {
            const res = await fetch(`${API}/chat/stream`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    query: txt,
                    session_id: currentSessionId,
                    use_web: document.getElementById("webToggle").checked
                })
            });

            const reader = res.body.getReader();
            const decoder = new TextDecoder();
            let aiText = "";
            let buffer = "";

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split("\n\n");
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.startsWith("data: ")) {
                        const jsonStr = line.slice(6);
                        if (jsonStr.includes("[DONE]")) break;
                        try {
                            const event = JSON.parse(jsonStr);
                            if (event.type === "token") {
                                if (aiText === "") aiBubble.innerHTML = ""; // 清空占位符
                                aiText += event.data;
                                aiBubble.innerText = aiText; // 使用 innerText 防止 HTML 注入
                            } else if (event.type === "status") {
                                // 状态显示逻辑 (可选)
                            }
                        } catch (e) {}
                    }
                }
                // 滚动到底部
                const box = document.getElementById("chatBox");
                box.scrollTop = box.scrollHeight;
            }
        } catch (e) {
            aiBubble.innerText = "Error: 连接断开";
        } finally {
            isGenerating = false;
            document.getElementById("sendBtn").disabled = false;
        }
    }

    // 6. 文件上传 (带转圈动画版)
    async function uploadFile(files) {
        if (!currentSessionId || files.length === 0) return;

        const file = files[0];
        const formData = new FormData();
        formData.append("file", file);
        formData.append("session_id", currentSessionId);

        // --- 修改点：这里插入带动画的 HTML ---
        // 我们创建一个临时的 ID，方便上传成功后更新这个气泡
        const tempId = "upload-" + Date.now();
        const loadingHtml = `
            <div id="${tempId}" style="display:flex; align-items:center">
                <div class="loading-spinner"></div>
                <span>正在上传并解析 ${file.name}...</span>
            </div>
        `;

        // appendBubble 现在支持插入 HTML
        const bubbleDiv = appendBubble("ai", "");
        bubbleDiv.innerHTML = loadingHtml;

        try {
            const res = await fetch(`${API}/upload`, { method: "POST", body: formData });

            // 获取刚才那个临时元素
            const statusDiv = document.getElementById(tempId);
            if (res.ok) {
                // 上传成功，把转圈去掉，换成勾选图标
                if (statusDiv) {
                    statusDiv.innerHTML = `<i class="fas fa-check-circle" style="color:#10a37f; margin-right:5px;"></i> ✅ 文件 ${file.name} 解析完成！`;
                }
            } else {
                if (statusDiv) statusDiv.innerHTML = `❌ 上传失败`;
            }
        } catch (e) {
            console.error(e);
            const statusDiv = document.getElementById(tempId);
            if (statusDiv) statusDiv.innerHTML = `❌ 网络错误`;
        }

        // 清空 input，防止无法重复上传同一个文件
        document.querySelector("input[type=file]").value = '';
    }

    // UI 辅助：添加气泡
    function appendBubble(role, text) {
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");
        div.className = `message ${role}`;

        const avatar = role === 'ai' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';

        div.innerHTML = `
            <div class="avatar ${role}">${avatar}</div>
            <div class="bubble">${text}</div>
        `;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;

        return div.querySelector(".bubble");
    }
</script>
</body>
</html>